<script type="text/javascript" src="#libraryLink('js/jquery-1.1.2.js')">
</script>
<script type="text/javascript" src="/sakai-citations-tool/js/citationscript.js">
</script>

<!-- template: sakai_citation-search.vm -->

<div class="portletBody">
  <div class="indnt1">

  <h3 id="advancedSearchHeader" style="display: none;">$tlang.getString("title.adv.search")</h3>
  <h3 id="basicSearchHeader">$tlang.getString("title.basic.search")</h3>

  <form name="$FORM_NAME" id="$FORM_NAME" method="post"
    action="#toolForm("CitationHelperAction")">
    <input name="sakai_action" id="sakai_action" value="doBeginSearch" type="hidden" />
    <input name="searchType" id="searchType" value="$basicSearchType" type="hidden" />
    
    <!-- hidden submit button (catches 'enter' key) -->
    <input name="submitSearch" id="submitSearch" value="Search" type="submit" style="display: none;"
      onclick="javascript: if( legalSearch( document.getElementById('searchType').value ) ) { checkSpinner( '$basicSearchType', '$advancedSearchType' ); } else { return false; }" />
    
    <p class="instruction">$tlang.getString("instr.search.main")</p>
    <p class="instruction">$tlang.getString("instr.search.sub")</p>

    #parse( "vm/citation/_advSearch.vm" )
    
    #parse( "vm/citation/_basicSearch.vm" )
    
    <div id="categories" class="shorttext">
      #set( $count = 0 )
      #foreach( $category in $categoryListing )
        #if( $category.hasSubCategories() )
          #set( $count = $count + 1 )
          <div style="display:none;" id="categoryDiv_$category.id" class="categoryDiv">
            <label for="selectCat_$category.id">
            #if( $velocityCount == 1 ) $tlang.getString("select.search")
            #else $tlang.getString("select.sub.search")
            #end
            </label>
 
            <select name="$category.id" id="$category.id" class="selectCategory" onchange="categoryChange($count, this.value)">
              #if( $velocityCount == 1 )
                #if( $defaultCategory )
                  <option value="$defaultCategory.id">$xilator.escapeHtml($defaultCategory.displayName)</option>
                #else
                  <option value="null"> - $tlang.getString("select.search") - </option>
                #end
              #else
                <option value="null"> - $tlang.getString("select.sub.search") - </option>
              #end

              #foreach( $subCategory in $category.subCategories )
                <option value="$subCategory.id">$xilator.escapeHtml($subCategory.displayName)</option>
              #end
            </select>
            
            #if( $velocityCount == 1 )
              <span id="databasesSelectedWidget" style="margin-left:1em;">($tlang.getString( "dbSelected.search" ) <span id="dbSelectedCount"></span>)</span>
            #end
          </div>
        #end
      #end
    </div>

    <div id="dbLoading">
      <p class="instruction">
        <img src="/library/image/sakai/spinner.gif" alt="$tlang.getString( "dbLoad.search" )" />
        $tlang.getString( "dbLoad.search" )
      </p>
    </div>
 
    <!-- database list is dynamically loaded using AJAX (see showDatabases()) -->
    <div id="databaseArea"></div>

    <p class="act">
      <input type="button" class="active" name="basicSearch" id="basicSearchButton"
        value="$tlang.getString("submit.search")"
        onclick="javascript: if( legalSearch( '$basicSearchType' ) ) { showSpinner( '.basicSearchLoad' ); document.getElementById('searchType').value='$basicSearchType'; submitform('$FORM_NAME'); } else { return false; }"
      />
      <input style="display: none;" type="button" class="active" name="advSearch"
        id="advancedSearchButton" value="$tlang.getString("submit.search")"
        onclick="javascript: if( legalSearch( '$advancedSearchType' ) ) { showSpinner( '.advancedSearchLoad' ); document.getElementById('searchType').value='$advancedSearchType'; submitform('$FORM_NAME'); } else { return false; }"
      />
      <input type="button" name="AddCitations" id="AddCitations"
        value="$tlang.getString("label.back.search")"
        onclick="javascript: document.getElementById('searchType').value='noSearch'; document.getElementById('sakai_action').value='doAddCitations';submitform('$FORM_NAME');"
      />
      #if( $resourcesAddAction )
      <input type="button" name="Cancel" id="Cancel"
        value="$tlang.getString("label.cancel")"
        onclick="javascript: document.getElementById('searchType').value='noSearch'; document.getElementById('sakai_action').value='doCancel'; submitform('$FORM_NAME');"
      />
      #else
      <input type="button" name="Done" id="Done"
        value="$tlang.getString("label.done")"
        onclick="javascript: document.getElementById('searchType').value='noSearch'; document.getElementById('sakai_action').value='doFinish'; submitform('$FORM_NAME');"
      />
      #end
      <span class="basicSearchLoad" style="display: none;">
        <img src="/library/image/sakai/spinner.gif" alt="$tlang.getString( "wait.search" )" />
        $tlang.getString( "wait.search" )
      </span>
      <span class="advancedSearchLoad" style="display: none;">
        <img src="/library/image/sakai/spinner.gif" alt="$tlang.getString( "wait.search" )" />
        $tlang.getString( "wait.search" )
      </span>
    </p>
  </form>
  </div>
</div>
<script type="text/javascript">
  // initialize the AJAX spinner
  $( "#dbLoading" ).ajaxStart( function() {
    $( this ).show();
  });
  $( "#dbLoading" ).ajaxStop( function() {
    $( this ).hide();
  });
  
function showTopCategory() {
  // get first div underneath #categories div
  $( ".categoryDiv:first" ).show();

  var selectBox = $( ".selectCategory:first" ).get(0);
  var selectedCatId = selectBox.options[0].value;

  if( selectedCatId != "null" ) {
    showDatabases( selectedCatId );
  }
}

function categoryChange( level, id ) {
  // hide databases
  $( "#databaseArea" ).hide();

  // hide categories below this level
  $( ".categoryDiv" ).gt( level-1 ).hide();
  
  // set selected count to 0
  $( "#dbSelectedCount" ).html( "0" );

  // show either databases or subcategories
  var categoryDiv = document.getElementById( id );
  if( categoryDiv ) {
    // subcategories exist
    $( "#categoryDiv_" + id ).show();
    var selectBox = document.getElementById( id );
    selectBox.selectedIndex = 0;
  } else {
    // no subcategories, show databases
    showDatabases( id );
  }
}

function showDatabases( id ) {
  $("#databaseArea").hide()
  if( id != "null" ) {
    $("#databaseArea").load("#toolForm("CitationHelperAction")&sakai_action=doDatabasePopulate&categoryId=" + id,
      function() { $("#databaseArea").show(); resizeFrame(); highlightCheckedSelections();  }
    );
  }
}

/*
 * Resizes the frame to avoid double scroll bars without scrolling to the top
 * of the page when making dynamic changes to the page.
 * This method has not been tested with IE 5.5.
 */
function resizeFrame() {
  var frame = parent.document.getElementById( window.name );

  if( frame ) {
    var clientH = document.body.clientHeight + 10;
    $( frame ).height( clientH );
  }
}

/*
 * Highlights rows selected in a table using a checkbox element
 */
function highlightCheckedSelections() {
  $( "tr[input]" ).removeClass( "highLightAdded" );
  $( "tr[input[@checked]]" ).addClass( "highLightAdded" );
  
  // set selected count
  $( "#dbSelectedCount" ).html( $( "tr[input[@checked]]" ).size() );
}

/*
 * Checks to make sure the user has entered search terms and selected
 * at least one database.
 *
 * Returns a boolean: true if search can proceed, false otherwise
 */
function legalSearch( searchType ) {
  if (!gotAQuery( searchType, '$basicSearchType', '$advancedSearchType' )) {
      alert("$tlang.getString( "noTerms.search" )");
      return false;
  }

  if (numCheckedDatabases() == 0) {
      alert("$tlang.getString( "noDbs.search" )");
      return false;
  }
  
  // user has entered search terms & selected at least one db
  return true;
}
</script>
